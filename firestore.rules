rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /products/{productId} {
      allow read: if true;
      allow write: if false;
    }

    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      match /swipes/{swipeId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      match /roomScans/{scanId} {
        allow read: if request.auth != null && request.auth.uid == userId;

        allow create: if request.auth != null && request.auth.uid == userId
          && request.resource.data.keys().hasOnly(["status","roomText","createdAt","updatedAt","imagePath","imageUrl"])
          && request.resource.data.status == "processing"
          && request.resource.data.roomText is string;

        allow update: if request.auth != null && request.auth.uid == userId
          && request.resource.data.diff(resource.data).changedKeys().hasOnly(["roomText","updatedAt","imagePath","imageUrl"]);

        allow delete: if false;
      }
    }

    match /leads/{leadId} {
      allow create: if request.auth != null
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.email is string
        && request.resource.data.email.size() >= 5
        && request.resource.data.subtotal is number
        && request.resource.data.subtotal == request.resource.data.subtotal
        && request.resource.data.bagCount is int
        && request.resource.data.wishlistCount is int;

      allow update: if request.auth != null
        && resource.data.uid == request.auth.uid
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.email is string
        && request.resource.data.email.size() >= 5
        && request.resource.data.subtotal is number
        && request.resource.data.subtotal == request.resource.data.subtotal
        && request.resource.data.bagCount is int
        && request.resource.data.wishlistCount is int;

      allow read, delete: if false;
    }

    match /events/{eventId} {
      function isAdmin() {
        return request.auth != null
          && (
            request.auth.token.admin == true
            || exists(/databases/$(database)/documents/admins/$(request.auth.uid))
          );
      }

      function allowedType(t) {
        return t in [
          "session_start","view_change",
          "scan_start","scan_success","scan_apply",
          "card_impression","product_open","swipe_pass",
          "wishlist_add","cart_add",
          "checkout_open","checkout_item_open","buy_click",
          "lead_submit",
          "pick_impression","pick_save","pick_dismiss",
          "share_click"
        ];
      }

      function needsProductId(t) {
        return t in [
          "card_impression","product_open","swipe_pass",
          "wishlist_add","cart_add",
          "checkout_item_open","buy_click",
          "pick_impression","pick_save","pick_dismiss"
        ];
      }

      function needsPurchaseUrl(t) {
        return t in ["buy_click","checkout_item_open"];
      }

      allow create: if request.auth != null
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.type is string
        && allowedType(request.resource.data.type)
        && request.resource.data.sessionId is string
        && request.resource.data.view is string
        && request.resource.data.source is string
        && request.resource.data.utm is map
        && request.resource.data.meta is map
        && (!needsProductId(request.resource.data.type) || request.resource.data.productId is string)
        && (!needsPurchaseUrl(request.resource.data.type)
            || (request.resource.data.purchaseUrl is string && request.resource.data.purchaseUrl.size() >= 8));

      allow get: if isAdmin();
  allow list: if isAdmin();

      allow update, delete: if false;
    }

    match /swipes/{docId} {
      allow read, write: if false;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
